<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hello Page</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #000;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>

    <script src="../lib/three_r80.js"></script>
	<script src="../lib/ammo_old.js"></script>
	<script src="../lib/physijs_worker.js"></script>
    <script src="../lib/physi.js"></script>

    <script src="../lib/oimo.js"></script>
    <script src="../lib/js/controls/OrbitControls.js"></script>
    <script src="../socket.io/socket.io.js"></script>
    <script src="../lib/js/controls/PointerLockControls.js"></script>
    <script src="../lib/js/controls/MouseControls.js"></script>
    <script src = "virtualjoystick.js"></script>

    <script src="../lib/js/libs/stats.min.js"></script>



    <script src="../share/Player.js"></script>
    <script src="../share/initWorld.js"></script>

    <script src="../share/updateOimoPhysics.js"></script>

    <script src="../share/cameraControl.js"></script>
    <script src="../share/checkRayCast.js"></script>
    <script src="../share/checkKeyStates.js"></script>
    <script src="../share/addPlayer.js"></script>

    <script src="predictPlayer.js"></script>
    <script src="client_world_droid.js"></script>
    <script src="../Raycaster/raycaster.js"></script>






    <script>



/*
        if (window.Worker) {
            var myWorker = new Worker("webWorker.js");
            myWorker.postMessage('go');

            console.log('worker!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!')
            myWorker.onmessage = function(e) {

                console.log(e.data);
            };

        }

*/



'use strict';

        var socket = io();
        socket.on('connect', function () {
            console.log('client connected ID '+ socket.id);
           // loadWorld();
            socket.emit('requestOldPlayers', {});




            function RTT() {
                socket.emit('rtt test', performance.now(), function (startTime) {
                    statsRTT.update();
                    var latency = performance.now() - startTime;
                    // console.log('rtt '+ latency);

                    RTT();
                });
            }

            //RTT();




        });  // пока ничего не делать при установлении подключения

        socket.on('createPlayer',function(data){
            console.log('createPlayer on');

            console.log(data)


            g_Player = addPlayer(data, geometryTemplate,multiMaterialTemplate, scene, objects, players, true); // cant USE CLIENT SOCKET.ID as of it may differ from server socket id https://github.com/socketio/socket.io/issues/2405
            console.log('SER/DE')
            console.log(JSON.parse(JSON.stringify(g_Player)))
            console.log(data);

            g_PlayerObject = objectForPID(g_Player.playerId);

            g_Player.camera = objectLoader.parse(data.cameraJSON);
            g_Player.camera.position.set(data.camPos.x,data.camPos.y, data.camPos.z)
            g_Player.camera.aspect = window.innerWidth / window.innerHeight;
            g_Player.camera.updateProjectionMatrix();
            g_Player.camera.lookAt(new THREE.Vector3( 0, 0, 0 ));
            g_Player.camera.updateMatrixWorld();
            socket.emit('onWindowResize', g_Player.camera.aspect); // Notify server about initial ASCPECT
            console.log('cam re-init');


        });

        socket.on('addOtherPlayer', function(data){ //TODO: PHYSICS on/off
            var player = addPlayer(data, geometryTemplate,multiMaterialTemplate, scene, objects, players, false);

            player.local_timer = data.ts_client;
            player.ts_client = data.ts_client;




//            var otherPlayerObject = objectForPID(player.playerId);
//
         //   otherPlayerObject.mass = 0 ;







            //g_PlayerObject.mass = 0 // setter to dynamic world ??
           // updateOnePlayer(data);

        });

        socket.on('removeOtherPlayer', function(data){
            console.log('removePLAYER '+ JSON.stringify(data) )
            removeOtherPlayer(data);
        });



        socket.on('updateWorld', function(data){


           // console.log('WORLD UPDATE FOR!!!!!!!!!!!!');
         //   console.log(socket.id);
            console.timeStamp('socket UPD World');
          //  updatePlayerData(data);
        })



        socket.on('rAF update from Server', function(data){

            // console.log('WORLD UPDATE FOR!!!!!!!!!!!!');
            //   console.log(socket.id);
           // updatePlayerData(data);



        })


        socket.on('outer_UPD_world_CLI',function(data){
           console.log('SOCKET FIRED');

            if (messageStack.length > 0) {messageStack.shift() ; console.log('shift DATA')};
            messageStack.push(data);
          //  if (g_Pending_server_hist.length > 0) g_Pending_server_hist.shift();
          //  g_Pending_server_hist.push(data);

            serverLastUpdateTime = data.serverLastUpdateTime; // GLOBALS
          //  console.log(serverLastUpdateTime)
            serverLastSentTime = data.serverLastSentTime; // GLOBALS

            console.log('serverLastSentTime ' + serverLastSentTime)
          //  console.log(serverLastSentTime)


           // console.log(data)


        //    console.log(messageStack.length)
           // alert(JSON.stringify(data[0]));
           /* data[0].forEach(function(p, i){
                console.log('P'+i+ ' mixerTime '+  p.mixerTime)
                //messageStack[0] = data;
            });
            //messageStack[0] = data;

            */

        })


        socket.on ('Hello', function (data){
            console.log(data)
        } )





// socket.on('socketID', function(data){
//     console.log('!!!!!!!!!!!: ' + data.id)
// })

    </script>
</head>
<body>
<div style="position:absolute; z-index:10; background:rgba(0,0,0,.5); padding:10px; color:#fff;">
    W key : foward<br>
    S key : backword<br>
    A key : left<br>
    D key : right<br>
    C key : toggle Crouch<br>
    <!--Enter key : chat<br>-->
    MouseDrag : rotate
</div>
<div id="container"></div>
<script>

</script>
</body>
</html>